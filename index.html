<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Wu(悟)Book - 错题本</title>
    <link rel="stylesheet" href="styles.css" />
</head>
<body>
    <header class="app-header">
        <h1>Wu(悟)Book</h1>
        <p class="tagline">A light-weight error book to help your child grow through mistakes.</p>
    </header>

    <main class="layout" id="layout">
        <section class="panel" aria-labelledby="entries-title">
            <div class="panel-header">
                <div class="panel-header__top">
                    <h2 id="entries-title">错题库</h2>
                    <div class="panel-links">
                        <a
                            href="#"
                            id="open-photo-check-panel"
                            class="panel-link"
                            aria-controls="photo-check-panel"
                            aria-expanded="false"
                        >拍照检查</a>
                        <a
                            href="#"
                            id="open-wizard-panel"
                            class="panel-link"
                            aria-controls="wizard-panel"
                            aria-expanded="false"
                        >错题向导</a>
                        <a href="#" id="open-entry-panel" class="panel-link" aria-controls="entry-panel" aria-expanded="false">新的错题</a>
                        <a href="#" id="open-log-panel" class="panel-link" aria-controls="log-panel" aria-expanded="false">查看活动日志</a>
                    </div>
                </div>
                <div class="filters">
                    <label>
                        <span>搜索</span>
                        <input type="search" id="search" placeholder="搜索题目、答案或原因" />
                    </label>
                    <label>
                        <span>题目类型</span>
                        <select id="type-filter">
                            <option value="">全部</option>
                        </select>
                    </label>
                    <label>
                        <span>学科</span>
                        <select id="subject-filter">
                            <option value="">全部</option>
                        </select>
                    </label>
                    <label>
                        <span>学期</span>
                        <select id="semester-filter">
                            <option value="">全部</option>
                        </select>
                    </label>
                    <label>
                        <span>来源</span>
                        <select id="source-filter">
                            <option value="">全部</option>
                        </select>
                    </label>
                    <label>
                        <span>错误原因</span>
                        <select id="error-reason-filter">
                            <option value="">全部</option>
                        </select>
                    </label>
                    <label>
                        <span>起始日期</span>
                        <input type="date" id="date-start" />
                    </label>
                    <label>
                        <span>结束日期</span>
                        <input type="date" id="date-end" />
                    </label>
                    <div class="filters__quick-links" role="group" aria-label="常用筛选">
                        <span>快捷：</span>
                        <a href="#" id="math-shortcut" class="filters__quick-link">数学</a>
                    </div>
                </div>
                <div class="entries-toolbar" role="group" aria-label="导出工具">
                    <button id="export-btn" class="btn" disabled>导出所有信息</button>
                    <button id="export-paper-btn" class="btn btn-secondary" disabled>生成试卷</button>
                </div>
            </div>

            <div id="stats" class="stats" role="status" aria-live="polite"></div>
            <div class="selection-toolbar">
                <p id="selection-status" class="selection-status" role="status" aria-live="polite">尚未选择题目。</p>
                <div class="selection-toolbar__actions">
                    <button type="button" id="select-filtered-btn" class="btn btn-secondary btn-compact">Select Filtered</button>
                    <button type="button" id="clear-selection-btn" class="btn btn-secondary btn-compact" disabled>Clear Selection</button>
                </div>
            </div>
            <div id="entries" class="entries" aria-live="polite">
                <table class="entries-table" id="entries-table" aria-label="错题列表">
                    <thead>
                        <tr>
                            <th scope="col" class="entries-table__select-col"></th>
                            <th scope="col">编号</th>
                            <th scope="col">题目摘要</th>
                            <th scope="col">学科</th>
                            <th scope="col">题型</th>
                            <th scope="col">错误原因</th>
                            <th scope="col">来源</th>
                            <th scope="col">备注</th>
                            <th scope="col">更新</th>
                            <th scope="col" class="entries-table__actions-col">操作</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="pagination" id="pagination" hidden>
                <div class="pagination__info" id="pagination-info"></div>
                <div class="pagination__controls">
                    <label class="pagination__page-size" for="page-size">
                        <span>每页显示</span>
                        <select id="page-size">
                            <option value="10">10</option>
                            <option value="20">20</option>
                            <option value="50">50</option>
                        </select>
                        <span>条</span>
                    </label>
                    <div class="pagination__buttons">
                        <button type="button" id="pagination-prev" class="btn btn-secondary btn-compact">上一页</button>
                        <button type="button" id="pagination-next" class="btn btn-secondary btn-compact">下一页</button>
                    </div>
                </div>
            </div>
        </section>

        <section class="panel" id="entry-panel" aria-labelledby="entry-form-title" hidden>
            <div class="panel-header">
                <div class="panel-header__top">
                    <h2 id="entry-form-title">新的错题</h2>
                    <a href="#" id="close-entry-panel" class="panel-link">返回错题列表</a>
                </div>
                <p>Add mistakes as they happen to keep everything organised.</p>
            </div>
            <form id="entry-form" class="form-grid">
                <label class="field">
                    <span>来源</span>
                    <input type="text" id="source" name="source" list="source-history" placeholder="教材、试卷等" />
                </label>
                <label class="field">
                    <span>学科</span>
                    <input type="text" id="subject" name="subject" list="subject-options" placeholder="数学、英语…" />
                </label>
                <label class="field">
                    <span>学期</span>
                    <select id="semester" name="semester">
                        <option value="">请选择</option>
                        <option value="八上" selected>八上</option>
                        <option value="八下">八下</option>
                        <option value="九上">九上</option>
                        <option value="九下">九下</option>
                    </select>
                </label>
                <label class="field">
                    <span>题目类型</span>
                    <input type="text" id="question-type" name="questionType" list="question-type-history" placeholder="选择题、填空题…" />
                </label>
                <label class="field">
                    <span>创建日期</span>
                    <input type="date" id="created-at" name="createdAt" />
                </label>
                <label class="field field--span-2">
                    <span>错误原因</span>
                    <textarea id="error-reason" name="errorReason" rows="2" placeholder="粗心、概念模糊等"></textarea>
                </label>
                <label class="field field--span-2">
                    <span>备注</span>
                    <textarea id="remark" name="remark" rows="2" placeholder="补充说明、复习提示等"></textarea>
                </label>
                <label class="field field--span-2">
                    <span>题目内容（文字）</span>
                    <textarea id="question-text" name="questionText" rows="3" placeholder="输入题干文本"></textarea>
                </label>
                <label class="field">
                    <span>题目图片</span>
                    <input type="file" id="question-image" name="questionImage" accept="image/*" />
                    <small>可上传题干照片。</small>
                </label>
                <label class="field field--span-2">
                    <span>答案（文字）</span>
                    <textarea id="answer-text" name="answerText" rows="3" placeholder="输入正确答案或解析"></textarea>
                </label>
                <label class="field">
                    <span>答案图片</span>
                    <input type="file" id="answer-image" name="answerImage" accept="image/*" />
                    <small>可上传答案照片。</small>
                </label>
                <button type="submit" class="btn btn-primary field--span-2">保存</button>
            </form>

            <div class="panel-footer">
                <label class="btn btn-secondary" for="import-input">Import Entries</label>
                <input type="file" id="import-input" accept="application/json" hidden />
                <button id="clear-btn" class="btn btn-danger">Clear All</button>
            </div>
        </section>

        <section class="panel" id="photo-check-panel" aria-labelledby="photo-check-title" hidden>
            <div class="panel-header">
                <div class="panel-header__top">
                    <h2 id="photo-check-title">拍照检查</h2>
                    <a href="#" id="close-photo-check-panel" class="panel-link">返回错题列表</a>
                </div>
                <p>上传带有题目与手写答案的照片，让 AI 自动分题并核对答案。</p>
            </div>

            <form id="photo-check-form" class="form-grid photo-check-form">
                <label class="field field--span-2">
                    <span>待检查的照片</span>
                    <input type="file" id="photo-check-image" name="images" accept="image/*" multiple required />
                    <small>可一次选择多张整页照片，需含印刷体题面和手写答案。</small>
                </label>
                <button type="submit" id="photo-check-submit" class="btn btn-primary field--span-2">开始检查</button>
            </form>

            <div id="photo-check-progress" class="photo-check-progress" role="status" aria-live="polite" hidden>
                <div class="photo-check-progress__bar" aria-hidden="true">
                    <div class="photo-check-progress__indicator"></div>
                </div>
                <div class="photo-check-progress__details">
                    <span class="photo-check-progress__pulse" aria-hidden="true"></span>
                    <p id="photo-check-progress-label" class="photo-check-progress__label"></p>
                </div>
            </div>

            <p id="photo-check-status" class="photo-check-status" role="status" aria-live="polite"></p>

            <section id="photo-check-results" class="photo-check-results" hidden>
                <h3>检查报告</h3>
                <p id="photo-check-summary" class="photo-check-summary"></p>
                <div id="photo-check-actions" class="photo-check-actions" hidden>
                    <p id="photo-check-selection-status" class="photo-check-selection-status">尚未选择题目。</p>
                    <div class="photo-check-actions__controls">
                        <button type="button" id="photo-check-save-btn" class="btn btn-primary" disabled>
                            保存到错题本
                        </button>
                    </div>
                </div>
                <div class="photo-check-results__content">
                    <div id="photo-check-report" class="photo-check-report"></div>
                </div>
            </section>
        </section>

        <section class="panel" id="wizard-panel" aria-labelledby="wizard-title" hidden>
            <div class="panel-header">
                <div class="panel-header__top">
                    <h2 id="wizard-title">错题向导</h2>
                    <a href="#" id="close-wizard-panel" class="panel-link">返回错题列表</a>
                </div>
                <p>先上传原始图片，然后对照图片补充错题内容。</p>
            </div>

            <div class="wizard" id="wizard">
                <div class="wizard-step" id="wizard-step-upload">
                    <h3>第 1 步：上传原始图片</h3>
                    <form id="wizard-upload-form" class="wizard-upload">
                        <label class="field field--span-2">
                            <span>原始图片</span>
                            <input type="file" id="wizard-original-image" name="originalImage" accept="image/*" required />
                            <small>上传整张试卷或原题照片，下一步将展示预览。</small>
                        </label>
                        <div class="wizard-ocr">
                            <button type="button" id="wizard-ocr-button" class="btn btn-secondary btn-compact">
                                使用 AI 识别文字
                            </button>
                            <p
                                id="wizard-ocr-status"
                                class="wizard-ocr__status"
                                role="status"
                                aria-live="polite"
                            ></p>
                        </div>
                        <div class="wizard-actions">
                            <button type="submit" class="btn btn-primary">继续</button>
                            <button type="button" id="wizard-cancel" class="btn btn-secondary">取消</button>
                        </div>
                    </form>
                </div>

                <div class="wizard-step" id="wizard-step-details" hidden>
                    <h3>第 2 步：补充错题信息</h3>
                    <div class="wizard-preview" id="wizard-preview" hidden>
                        <img id="wizard-preview-image" alt="原始错题图片预览" />
                    </div>
                    <form id="wizard-form" class="form-grid">
                        <label class="field field--span-2">
                            <span>题目内容（文字）</span>
                            <textarea id="wizard-question-text" name="questionText" rows="3" placeholder="输入题干文本"></textarea>
                        </label>
                        <label class="field field--span-2">
                            <span>题目图片</span>
                            <input type="file" id="wizard-question-image" name="questionImage" accept="image/*" />
                            <small>可上传题干照片。</small>
                        </label>
                        <label class="field field--span-2">
                            <span>答案（文字）</span>
                            <textarea id="wizard-answer-text" name="answerText" rows="3" placeholder="输入正确答案或解析"></textarea>
                        </label>
                        <label class="field field--span-2">
                            <span>答案图片</span>
                            <input type="file" id="wizard-answer-image" name="answerImage" accept="image/*" />
                            <small>可上传答案照片。</small>
                        </label>
                        <label class="field">
                            <span>来源</span>
                            <input type="text" id="wizard-source" name="source" list="source-history" placeholder="教材、试卷等" />
                        </label>
                        <label class="field">
                            <span>学科</span>
                            <input type="text" id="wizard-subject" name="subject" list="subject-options" placeholder="数学、英语…" />
                        </label>
                        <label class="field">
                            <span>学期</span>
                            <select id="wizard-semester" name="semester">
                                <option value="">请选择</option>
                                <option value="八上">八上</option>
                                <option value="八下">八下</option>
                                <option value="九上">九上</option>
                                <option value="九下">九下</option>
                            </select>
                        </label>
                        <label class="field">
                            <span>题目类型</span>
                            <input type="text" id="wizard-question-type" name="questionType" list="question-type-history" placeholder="选择题、填空题…" />
                        </label>
                        <label class="field">
                            <span>创建日期</span>
                            <input type="date" id="wizard-created-at" name="createdAt" />
                        </label>
                        <label class="field field--span-2">
                            <span>错误原因</span>
                            <textarea id="wizard-error-reason" name="errorReason" rows="2" placeholder="粗心、概念模糊等"></textarea>
                        </label>
                        <label class="field field--span-2">
                            <span>备注</span>
                            <textarea id="wizard-remark" name="remark" rows="2" placeholder="补充说明、复习提示等"></textarea>
                        </label>
                        <div class="wizard-actions wizard-actions--form">
                            <button type="button" id="wizard-back" class="btn btn-secondary">返回上一步</button>
                            <button type="submit" class="btn btn-primary">保存</button>
                        </div>
                    </form>
                </div>
            </div>
        </section>

        <section class="panel panel--log" id="log-panel" aria-labelledby="activity-log-title" hidden>
            <div class="panel-header panel-header--log">
                <div>
                    <h2 id="activity-log-title">Activity Log</h2>
                    <p>Track uploads, edits, deletes, and imports in real time.</p>
                </div>
                <div class="log-controls">
                    <button id="refresh-log-btn" class="btn btn-secondary" type="button">Refresh log</button>
                    <span id="log-status" class="log-status" role="status" aria-live="polite"></span>
                    <a href="#" id="close-log-panel" class="panel-link panel-link--muted">返回错题列表</a>
                </div>
            </div>
            <ol id="activity-log" class="log-list" aria-live="polite"></ol>
        </section>
    </main>

    <template id="entry-template">
        <tr class="entry-row" data-id="">
            <td class="entry-cell entry-cell--select">
                <input type="checkbox" class="entry-select-input" aria-label="选择错题" />
            </td>
            <td class="entry-cell entry-cell--code"></td>
            <td class="entry-cell entry-cell--summary">
                <div class="entry-summary-text" hidden></div>
                <div class="entry-summary-image" hidden>
                    <img class="entry-summary-image__img" alt="题目图片摘要" loading="lazy" />
                </div>
            </td>
            <td class="entry-cell entry-cell--subject"></td>
            <td class="entry-cell entry-cell--type"></td>
            <td class="entry-cell entry-cell--reason"></td>
            <td class="entry-cell entry-cell--source"></td>
            <td class="entry-cell entry-cell--remark"></td>
            <td class="entry-cell entry-cell--updated"></td>
            <td class="entry-cell entry-cell--actions">
                <div class="entry-actions">
                    <button class="btn-icon" data-action="toggle-details" title="查看详情" aria-expanded="false">📄</button>
                    <button class="btn-icon" data-action="edit" title="编辑">✏️</button>
                    <button class="btn-icon" data-action="delete" title="删除">🗑️</button>
                </div>
            </td>
        </tr>
        <tr class="entry-detail-row" data-id="" hidden>
            <td colspan="10">
                <div class="entry-detail">
                    <div class="entry-detail__meta">
                        <span class="entry-detail__code" hidden></span>
                        <span class="entry-detail__subject"></span>
                        <span class="entry-detail__type"></span>
                        <span class="entry-detail__source"></span>
                        <span class="entry-detail__created"></span>
                        <span class="entry-detail__updated"></span>
                    </div>
                    <div class="entry-detail__content">
                        <section class="entry-section entry-section--question">
                            <h4>题目</h4>
                            <p class="entry-question-text"></p>
                            <figure class="entry-question-image"></figure>
                            <div class="entry-image-zoom entry-image-zoom--question" hidden>
                                <label>
                                    <span>图片缩放</span>
                                    <input
                                        type="range"
                                        class="entry-image-zoom__input"
                                        min="30"
                                        max="120"
                                        step="1"
                                        value="100"
                                    />
                                    <output class="entry-image-zoom__value">100%</output>
                                </label>
                            </div>
                        </section>
                        <section class="entry-section entry-section--answer">
                            <h4>答案</h4>
                            <p class="entry-answer-text"></p>
                            <figure class="entry-answer-image"></figure>
                        </section>
                        <section class="entry-section entry-section--original" hidden>
                            <h4>原始图片</h4>
                            <figure class="entry-original-image"></figure>
                        </section>
                        <p class="entry-error-reason" hidden></p>
                        <p class="entry-remark" hidden></p>
                        <section class="entry-similar" hidden>
                            <h4>相似题目</h4>
                            <ul></ul>
                        </section>
                    </div>
                </div>
            </td>
        </tr>
    </template>

    <dialog id="photo-check-save-dialog">
        <form method="dialog" id="photo-check-save-form" class="photo-check-save-form">
            <h2>保存到错题本</h2>
            <p id="photo-check-save-status" class="photo-check-save-status" role="status" aria-live="polite"></p>
            <div id="photo-check-save-list" class="photo-check-save-list"></div>
            <menu class="dialog-actions">
                <button type="button" id="photo-check-save-cancel" class="btn">取消</button>
                <button type="submit" id="photo-check-save-confirm" class="btn btn-primary">保存</button>
            </menu>
        </form>
    </dialog>

    <dialog id="edit-dialog">
        <form method="dialog" id="edit-form" class="form-grid">
            <h2>Edit Entry</h2>
            <input type="hidden" id="edit-id" />
            <label class="field">
                <span>来源</span>
                <input type="text" id="edit-source" list="source-history" />
            </label>
            <label class="field">
                <span>学科</span>
                <input type="text" id="edit-subject" list="subject-options" />
            </label>
            <label class="field">
                <span>学期</span>
                <select id="edit-semester">
                    <option value="">请选择</option>
                    <option value="八上">八上</option>
                    <option value="八下">八下</option>
                    <option value="九上">九上</option>
                    <option value="九下">九下</option>
                </select>
            </label>
            <label class="field">
                <span>题目类型</span>
                <input type="text" id="edit-question-type" list="question-type-history" />
            </label>
            <label class="field field--span-2">
                <span>创建日期</span>
                <input type="date" id="edit-created-at" />
            </label>
            <label class="field field--span-2">
                <span>错误原因</span>
                <textarea id="edit-error-reason" rows="2"></textarea>
            </label>
            <label class="field field--span-2">
                <span>备注</span>
                <textarea id="edit-remark" rows="2"></textarea>
            </label>
            <label class="field field--span-2">
                <span>题目内容（文字）</span>
                <textarea id="edit-question-text" rows="3"></textarea>
            </label>
            <label class="field field--span-2">
                <span>答案（文字）</span>
                <textarea id="edit-answer-text" rows="3"></textarea>
            </label>
            <menu class="dialog-actions">
                <button value="cancel" class="btn">Cancel</button>
                <button value="confirm" class="btn btn-primary">Save changes</button>
            </menu>
        </form>
    </dialog>

    <dialog id="confirm-clear">
        <form method="dialog" class="confirm-dialog">
            <h2>Delete all entries?</h2>
            <p>This action will remove every saved mistake. You can export a backup before clearing.</p>
            <menu class="dialog-actions">
                <button value="cancel" class="btn">Cancel</button>
                <button value="confirm" class="btn btn-danger">Delete</button>
            </menu>
        </form>
    </dialog>

    <datalist id="subject-options">
        <option value="数学"></option>
        <option value="英语"></option>
        <option value="语文"></option>
        <option value="物理"></option>
        <option value="化学"></option>
        <option value="生物"></option>
        <option value="历史"></option>
        <option value="地理"></option>
        <option value="政治"></option>
        <option value="科学"></option>
    </datalist>

    <datalist id="source-history"></datalist>
    <datalist id="question-type-history"></datalist>

    <script src="app.js" type="module"></script>
</body>
</html>
